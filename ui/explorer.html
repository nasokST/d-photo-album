<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>DPhotoAlbum</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.18/js/dataTables.bootstrap.min.js "></script>
<style type="text/css">
	.bs-example{
		margin: 20px;
	}
</style>

<script type="application/javascript">


	var port = "8083";

	var getUrlParameter = function getUrlParameter(sParam) {
		var sPageURL = decodeURIComponent(window.location.search.substring(1)),
			sURLVariables = sPageURL.split('&'),
			sParameterName,
			i;

		for (i = 0; i < sURLVariables.length; i++) {
			sParameterName = sURLVariables[i].split('=');

			if (sParameterName[0] === sParam) {
				return sParameterName[1] === undefined ? true : sParameterName[1];
			}
		}
	};
	
	function getFormData($form){
		var unindexed_array = $form.serializeArray();
		var indexed_array = {};

		$.map(unindexed_array, function(n, i){
			indexed_array[n['name']] = n['value'];
		});

		return indexed_array;
	}
	
	function createTransaction(){
		var $form = $("#sender"); //transactionData
		//password password_tr
		// cryptodata is json json_tr
		
		var tr_data = {transactionData:getFormData($form), password:$("#password_tr").val(), cryptoData:JSON.parse($("#json_tr").val())}; 
		
		$.ajax({
		  url: 'http://localhost:' + port + '/wallet/transaction',
		  type: 'POST',
          dataType: 'json',
		  contentType: "application/json; charset=utf-8",
		  data: JSON.stringify(tr_data),
		  success: function(data) {
			$("#transaction_response").append("<div id='success-alert' class='alert alert-info alert-dismissible fade in'><a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a>Transaction created. Expect your ShumenCoin soon.</div>");
		  },
		  error: function(data) {
			$("#transaction_response").append("<div class='alert alert-danger alert-dismissible fade in'><a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a>" + data.responseJSON + "</div>");
		  },
		});
	}
	
	
	function getCommentsForPhoto() {
		var category = $("#category").val();
		var photoindex = $("#photoindex").val();

		console.log(category);
		console.log(photoindex);

		$.ajax({
			url: 'http://localhost:' + port + '/dphoto/comment/' + category + '/' + photoindex,
			type: 'GET',
			dataType: 'json',
			success: function(data) { 
				fillInComments(data.comments,"comments-table");
			},
			error: function(data) {
				console.log('http://localhost:' + port + 'dphoto/comment/' + category + '/' + photoindex);
			},
			beforeSend: setHeader
		});
	}

	function fillInComments(data, table) {

		$('#' + table).DataTable().clear().destroy();	
		$.each(data, function(index, element) {
			var html = "<tr>"
			+ "<td>" + element.autor + "</td>"
			+ "<td>" + element.dataTime + "</td>"
			+ "<td>" + element.text + "</td>"
			$( "#" + table + "-body" ).append(html);
		});	
		$('#' + table).DataTable({
                "fixedHeader": true,
                "responsive": true,
				"lengthChange": false,               
				"searching": false,
				"paginate": false,
				"info": false,});
	}		
	
	
	function createNewWallet() {
		var address = $("#password").val();
		$.ajax({
		  url: 'http://localhost:' + port + '/wallet/account',
		  type: 'POST',
		  data: address,
		  processData: false,
		  success: function(data) {
			$("#wallet-json").remove();
			$("#json-container").append("<div class='alert alert-danger alert-dismissible fade in' id='wallet-json' style='white-space:pre-wrap; word-wrap:break-word;'>" + data + "</div>");
		  },
		  error: function(data) {
			$("#json-container").append("<div class='alert alert-danger alert-dismissible fade in'><a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a>Something went wrong</div>");
		  },
		  beforeSend: setHeader
		});
	}

	function uploadFile() {

		console.log("sadasdas");

		/*var address = $("#password").val();*/
		var fileUploadData = new FormData();
		fileUploadData.append('file', $('input#file.findDocumentOnboarding')[0].files[0]);

		$.ajax({
		  url: 'http://localhost:' + port + '/dphoto',
		  type: 'POST',
		  data: fileUploadData,
     	  contentType:'multipart/form-data',
     	  dataType: 'json',
		  processData: false,
		  success: function(data) {
			$("#wallet-json").remove();
			$("#json-container").append("<div class='alert alert-danger alert-dismissible fade in' id='wallet-json' style='white-space:pre-wrap; word-wrap:break-word;'>" + data + "</div>");
		  },
		  error: function(data) {
			$("#json-container").append("<div class='alert alert-danger alert-dismissible fade in'><a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a>Something went wrong</div>");
		  },
		  beforeSend: setHeader
		});
	}	

$( document ).ready(function() {

	var portParam = getUrlParameter('port');
	if(portParam != null) {
		port = portParam;
	}
	
	window.setTimeout(function() { $(".alert-message").alert('close'); }, 2000);
	
	(function(){
	   var f = function() {
	   $.ajax({
		  url: 'http://localhost:' + port + '/categories/all',
		  type: 'GET',
		  dataType: 'json',
		  success: function(data) { 
			fillInCategoriesTable(data);
		  },
		  beforeSend: setHeader
		});
		
		$.ajax({
			url: 'http://localhost:' + port + '/dphoto/1',
			type: 'GET',
			dataType: 'json',
			success: function(data) { 
				fillInCategory(data,"family-category-table");
			},
			beforeSend: setHeader
		});

		$.ajax({
			url: 'http://localhost:' + port + '/dphoto/2',
			type: 'GET',
			dataType: 'json',
			success: function(data) { 
				fillInCategory(data,"sea-category-table");
			},
			beforeSend: setHeader
		});

		$.ajax({
			url: 'http://localhost:' + port + '/dphoto/3',
			type: 'GET',
			dataType: 'json',
			success: function(data) { 
				fillInCategory(data,"montain-category-table");
			},
			beforeSend: setHeader
		});

		$.ajax({
		  url: 'http://localhost:' + port + '/dphoto/3',
		  type: 'GET',
		  dataType: 'json',
		  success: function(data) { 
			fillInCategory(data);
		  },
		  beforeSend: setHeader
		});

	   };
	   window.setInterval(f, 10000);
	   f();
	})();

  	
	function fillInCategoriesTable(data) {
		$('#categories-table').DataTable().clear().destroy();
		$.each(data, function(index, element) { 		
			var html = "<tr>"
						/*+ "<td>" + element.type +"</td>"*/
						+ "<td>" + element.name +"</td>"
						/*+ "<td style='width:40px'>" + element.address +"</td>"*/
					+ "</tr>";
			$( "#categories-table-body" ).append(html);
		});
		$('#categories-table').DataTable({
                "fixedHeader": true,
                "responsive": true,
				"lengthChange": false,               
				"searching": false,
				"paginate": false,
				"info": false,});
	}
		
	function fillInCategory(data, table) {

		$('#' + table).DataTable().clear().destroy();	
		$.each(data, function(index, element) {
			var html = "<tr>"
			+ "<td>" + element.index + "</td>"
			+ "<td>" + element.owner + "</td>"
			/*+ "<td>" + element.file + "</td>"*/
			+ "<td> <img src=\"https://ipfs.io/ipfs/" + element.ipfsHash + "\" class=\"lltr\"></img></td>"
			$( "#" + table + "-body" ).append(html);
		});	
		$('#' + table).DataTable({
                "fixedHeader": true,
                "responsive": true,
				"lengthChange": false,               
				"searching": false,
				"paginate": false,
				"info": false,});
	}
});

function setHeader(xhr) {
	xhr.setRequestHeader('Origin', 'http://localhost:' + port + '/');
}

$(".uploadImageD").on("click", function (evt) {

	console.log("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa")

    IdToEdit = $(this).closest('tr').siblings().find('p.important').text();
    alert(IdToEdit);
    var url = "http://localhost:10110/MavenProject/api123/Onboard/uploads/"+IdToEdit;
    evt.preventDefault();

    var documentData = new FormData();
    documentData.append("file", $('input#file.findDocumentOnboarding')[0].files[0]);
    $.ajax({
        url: url,
        type: 'PUT',
        data: {'testBlob': (documentData)},
        async: false,
        cache: false,
        contentType: false,
        enctype: 'multipart/form-data',
        processData: false,
        success: function (response) {
            alert(response);
        }
    });

    return false;
});


</script>
</head>
<body>
<div class="bs-example">
    <ul class="nav nav-tabs">
        <li class="active"><a data-toggle="tab" href="#sectionA">Categories</a></li>
        <li><a data-toggle="tab" href="#sectionB">Family</a></li>
        <li><a data-toggle="tab" href="#sectionC">Sea</a></li>
        <li><a data-toggle="tab" href="#sectionD">Montain</a></li>
        <li><a data-toggle="tab" href="#sectionF">Read comments for photo...</a></li>
        <li><a data-toggle="tab" href="#sectionG">Wallet</a></li>
        <li><a data-toggle="tab" href="#sectionH">Sender</a></li>
        <li class='pull-right'><h4>DPhotoAlbum</h4></li>
    </ul>
    <div class="tab-content">
        <div id="sectionA" class="tab-pane fade in active">
            <h3>Categories</h3>
			<div class="container-fluid">
				<table id="categories-table" class="table table-striped table-bordered">
					<thead>
						<tr>
							<!-- <th>Type</th> -->
							<th>Name</th>
							<!-- <th>Contract Address</th> -->
						</tr>
					</thead>
					<tbody id="categories-table-body">
					</tbody>
				</table>
			</div>
        </div>
        <div id="sectionB" class="tab-pane fade">
            <h3>Family</h3>
					<form enctype="multipart/form-data" method="post" name="fileinfo"">
						  <label>PK:</label>
						  <input type="text" placeholder="private key" /><br />
						  <label>category:</label>
						  <input type="text" name="category" placeholder="FAMILY" disabled="disabled"  /><br />
						  <input type="file" name="file"/>
						  <input type="submit" value="Upload" class="uploadImageD" />
						</form>            
			<div class="container-fluid">
				<table id="family-category-table" class="table table-striped table-bordered">
<!-- 				    <form id="frm" method="post" enctype="multipart/form-data" target="uploadFrame" onsubmit="Upload()">
				        <input type="file" id="file" name="dummyname" />
				        <input type="text" id="category" placeholder="FAMILY" disabled="disabled" />
				        <input type="text" id="pk" placeholder="private key"/>
				        <input type="submit" value="Upload""/>
				    </form>		 -->			
					<thead>
						<tr>
							<th>Index</th>
							<th>Photographer</th>
							<th>Photo</th>
						</tr>
					</thead>
					<tbody id="family-category-table-body">
					</tbody>
				</table>
			</div>
        </div>
        <div id="sectionC" class="tab-pane fade">
            <h3>Sea</h3>
			<div class="container-fluid">
				<table id="sea-category-table" class="table table-striped table-bordered">
					<thead>
						<tr>
							<th>Index</th>
							<th>Photographer</th>
							<th>Photo</th>
						</tr>
					</thead>
					<tbody id="sea-category-table-body">
					</tbody>
				</table>
			</div>
        </div>
        <div id="sectionD" class="tab-pane fade">
            <h3>Montain</h3>
			<div class="container-fluid">
				<table id="montain-category-table" class="table table-striped table-bordered">
					<thead>
						<tr>
							<th>Index</th>
							<th>Photographer</th>
							<th>Photo</th>
						</tr>
					</thead>
					<tbody id="montain-category-table-body">
					</tbody>
				</table>
			</div>
        </div>
        <div id="sectionF" class="tab-pane fade">
            <h3>Read comments for photo</h3>
			<div class="container-fluid">
				<label for="category">Category:</label>
				<input type="text" id="category"> 
				<label for="photoindex">photoindex</label>
				<input type="text" id="photoindex"> 
				<button onclick="javascript:getCommentsForPhoto()" class="btn btn-default">get comments</button>
				<div id="alert-container"></div>
				<table id="comments-table" class="table table-striped table-bordered">
					<thead>
						<tr>
							<th>Autor</th>
							<th>Time</th>
							<th>Text</th>
						</tr>
					</thead>
					<tbody id="comments-table-body">
					</tbody>
				</table>				
			</div>
        </div>
        <div id="sectionG" class="tab-pane fade">
            <h3>Wallet</h3>
			<div class="container-fluid">
				<label for="password">Encrypt your password:</label>
				<input type="password" style="width:400px" id="password"> <button id="submit" onclick="javascript:createNewWallet()" class="btn btn-default">Submit</button>
				<div id="json-container"></div>
			</div>
        </div>
        <div id="sectionH" class="tab-pane fade">
            <h3>Sender</h3>
			<div class="container-fluid">
				<label for="json">JSON:</label>
				<input type="text-area" style="width:400px" name="json" id="json_tr"></br>
				<label for="password">Password:</label>
				<input type="text" style="width:400px" id="password_tr" name="password"> 
				<form class="form" id="sender">
					<label for="to">To:</label>
					<input type="text" style="width:400px" name="to"> </br>
					<label for="value">Value:</label>
					<input type="text" style="width:400px" name="value"> </br>
					<label for="fee">Fee:</label>
					<input type="text" style="width:400px" name="fee"> </br>
					<label for="data">Data:</label>
					<input type="text" style="width:400px" name="data"> </br>
					<button id="submit" onclick="javascript:createTransaction(); return false;" class="btn btn-default">Submit</button> </br></br>
				</form>
				<div id="transaction_response"></div>
			</div>
        </div>
    </div>
</div>
</body>
</html>                            